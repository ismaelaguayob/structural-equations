# Preparación del entorno de trabajo
```{r}
pacman::p_load(dplyr, tidyverse, haven, MplusAutomation, flextable, officer, ggplot2, purrr, table1, officer, psych)

options(scipen = 999)
rm(list = ls()) 
set.seed(123)
```

# Carga de los datos brutos

```{r}
data <- readRDS("./pisa22_proc.rds")

```

# Filtrado y procesamiento de variables para el análisis

```{r}
proc_data <- data |> 
  select(
    -CNTRYID, 
    -CNTSCHID,
    -collect_data, 
    -create_media, 
    -change_settings,
    -identify_app,
    -develop_webpage, 
    CNT, 
    sex,
    gen1 = search_info, 
    gen2 = evaluate_info, 
    gen3 = share_content, 
    gen4 = pair_collab, 
    gen5 = explain_content, 
    gen6 = write_text,
    spec1 = programming, 
    spec2 = logical_solution, 
    spec3 = identify_error
)

items_dse <- c(
  "gen1", "gen2", "gen3",
  "gen4", "gen5", "gen6",
  "spec1", "spec2", "spec3"
)

proc_data <- proc_data |>
  filter(if_any(all_of(items_dse), ~ !is.na(.))) |>
  group_by(CNT) |>
  slice_sample(n = 96) |>
  ungroup()
```

# Creación de tabla de descriptivos

```{r}
nombres_descriptivos <- c(
  "gen1" = "Buscar información",
  "gen2" = "Evaluar información",
  "gen3" = "Compartir información",
  "gen4" = "Colaborar en grupo",
  "gen5" = "Explicar cómo compartir",
  "gen6" = "Escribir/editar texto",
  "spec1" = "Crear programa",
  "spec2" = "Pasos lógicos",
  "spec3" = "Identificar error"
)

descriptivos <- psych::describe(proc_data[items_dse])
desc <- psych::response.frequencies(proc_data[items_dse])
desc <- as.data.frame(desc)
desc$skew <- descriptivos$skew
desc$kurtosis <- descriptivos$kurtosis


descriptivos_df <- desc |>
  rownames_to_column(var = "variable") |>
  select(
    variable,
    `1`, `2`, `3`, `4`,
    Asimetría = skew,
    Curtosis = kurtosis,
    `% Casos perdidos` = miss
  ) |>
  mutate(`% Casos perdidos` = `% Casos perdidos` * 100) |>
  mutate(`1` = `1` * 100) |>
  mutate(`2` = `2` * 100) |>
  mutate(`3` = `3` * 100) |>
  mutate(`4` = `4` * 100) |>
  mutate(variable = factor(variable, levels = items_dse)) |>
  arrange(variable) |>
  mutate(variable = recode(variable, !!!nombres_descriptivos)) |>
  rename(Ítem = variable)

```

# Preparación de data para Mplus

```{r}
prepareMplusData(proc_data, filename="mplus_files/pisadse.dat", inpfile = FALSE)
```

# Correr los modelos con runModels

```{r}
runModels("./mplus_files/")
```

```{r}
gen_dse <- proc_data |> select(gen1,gen2,gen3,gen4,gen5,gen6)
spec_dse <- proc_data |> select(spec1, spec2, spec3)
psych::alpha(gen_dse)
psych::alpha(spec_dse)
```
# Leer los modelos con readModels

```{r}
resultados <- readModels("./mplus_files_first_task/")
# Matriz de pearsons
pearsons <- resultados$pearson.out$sampstat$correlations
# Matriz policorica
polychoric <- resultados$polychoric.out$sampstat$correlations

diag(polychoric) <- 1
par(mfrow = c(1, 1))
corrplot::corrplot(pearsons, method = 'number', type = 'lower', tl.col = 'black')
corrplot::corrplot(polychoric, method = 'number', type = 'lower', tl.col = 'black')

png("figures/correlaciones.png", 
    width = 3000, 
    height = 1500, 
    res = 300, 
    bg = "transparent")

par(mfrow = c(1, 2))
corrplot::corrplot(pearsons, method = 'number', type = 'lower', tl.col = 'black')
corrplot::corrplot(polychoric, method = 'number', type = 'lower', tl.col = 'black')

dev.off()

```

# Convertir a tablas flextable y exportar como docx

## Nombres descriptivos

```{r}
nombres_nuevos <- c(
  "PROGRAMM" = "Crear\nprograma",
  "LOGICAL_" = "Pasos\nlógicos",
  "IDENTIFY" = "Identificar\nerror",
  "SEARCH_I" = "Buscar\ninformación",
  "EVALUATE" = "Evaluar\ninformación",
  "SHARE_CO" = "Compartir\ninformación",
  "PAIR_COL" = "Colaborar\nen grupo",
  "EXPLAIN_" = "Explicar cómo\ncompartir",
  "WRITE_TE" = "Escribir/\neditar texto"
)

nombres_actuales <- rownames(pearsons)

nombres_mapeados <- nombres_nuevos[nombres_actuales]

rownames(pearsons) <- nombres_mapeados
colnames(pearsons) <- nombres_mapeados

rownames(polychoric) <- nombres_mapeados
colnames(polychoric) <- nombres_mapeados
```


## Funciones para estilizar las tablas

```{r}
style_desc_table <- function(ft) {
  
  ft <- ft |>
    # GRUPO 1: Las columnas de porcentaje (Respuestas + Missings)
    # Usamos digits = 1 (ej: 25.4%) y agregamos el sufijo
    colformat_double(
      j = c("1", "2", "3", "4", "% Casos perdidos"), 
      digits = 1, 
      suffix = "%"
    ) |>
    
    # GRUPO 2: Los coeficientes estadísticos (Asimetría y Curtosis)
    # Usamos digits = 2 y SIN sufijo
    colformat_double(
      j = c("Asimetría", "Curtosis"), 
      digits = 2
    ) |>
    
    # --- El resto del estilo se mantiene igual ---
    border_remove() |>
    hline_top(border = fp_border(width = 2), part = "header") |> 
    hline_bottom(border = fp_border(width = 2), part = "body") |>
    hline(i = 1, border = fp_border(width = 1.5), part = "header") |>
    
    bold(part = "header") |>
    font(fontname = "Calibri", part = "all") |>
    fontsize(size = 10, part = "body") |>
    fontsize(size = 11, part = "header") |>
    
    padding(padding = 3, part = "all") |>
    align(align = "center", part = "header") |>
    align(align = "left", part = "body", j = 1) |> 
    align(align = "center", part = "body", j = 2:ncol(ft$body$dataset)) |> 
    autofit() 

  return(ft)
}
```



## Exportación de tablas en formato docx


```{r}

ft_descriptivos <- flextable(descriptivos_df) |>
  style_desc_table() |> 
  add_header_row(values = "Tabla 2: Estadísticos Descriptivos de los Ítems", colwidths = ncol(descriptivos_df))

save_as_docx(
  ft_descriptivos, 
  path = "figures/tabla_descriptivos.docx"
)

```