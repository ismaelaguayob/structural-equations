# Preparación del entorno de trabajo
```{r}
pacman::p_load(dplyr, tidyverse, haven, MplusAutomation, flextable, officer, ggplot2, purrr, table1, officer, psych)

options(scipen = 999)
rm(list = ls()) 
set.seed(123)
```

# Carga de los datos brutos

```{r}
data <- readRDS("./pisa22_proc.rds")

```

# Filtrado y procesamiento de variables para el análisis

```{r}
proc_data <- data |> 
  select(
    -collect_data, 
    -create_media, 
    -change_settings,
    -identify_app,
    -develop_webpage, 
    CNT, 
    sex,
    SENWT,
    ICTENQ,
    ICTHOME,
    ICTWKEND,
    SDLEFF,
    ESCS,
    gen1 = search_info, 
    gen2 = evaluate_info, 
    gen3 = share_content, 
    gen4 = pair_collab, 
    gen5 = explain_content, 
    gen6 = write_text,
    spec1 = programming, 
    spec2 = logical_solution, 
    spec3 = identify_error,
    ictsch1 = IC174Q01JA,
    ictsch2 = IC174Q02JA,
    ictsch3 = IC174Q03JA,
    ictsch4 = IC174Q04JA,
    ictsch5 = IC174Q05JA,
    ictsch6 = IC174Q06JA,
    ictsch7 = IC174Q07JA,
    ictsch8 = IC174Q08JA,
    ictsch9 = IC174Q09JA,
    ictsch10 = IC174Q10JA,
    self_ln1 = ST355Q01JA,
    self_ln2 = ST355Q02JA,
    self_ln3 = ST355Q03JA,
    self_ln4 = ST355Q04JA,
    self_ln5 = ST355Q05JA,
    self_ln6 = ST355Q06JA,
    self_ln7 = ST355Q07JA,
    self_ln8 = ST355Q08JA,
    ocio_1 = IC178Q01JA,
    ocio_2 = IC178Q02JA,
    ocio_3 = IC178Q03JA,
    ocio_4 = IC178Q04JA,
    ocio_5 = IC178Q05JA,
    ocio_6 = IC178Q06JA,
    ocio_7 = IC178Q07JA,
    access_1 = IC171Q01JA,
    access_2 = IC171Q02JA,
    access_3 = IC171Q03JA,
    access_4 = IC171Q04JA,
    access_5 = IC171Q05JA,
    access_6 = IC171Q06JA
)

items_dse <- c(
  "gen1", "gen2", "gen3",
  "gen4", "gen5", "gen6",
  "spec1", "spec2", "spec3"
)

items_ictsch <- c(
  "ictsch1", "ictsch2", "ictsch3",
  "ictsch4", "ictsch4", "ictsch5",
  "ictsch5", "ictsch6", "ictsch6",
  "ictsch7", "ictsch8", "ictsch9", 
  "ictsch10"
)

items_self_ln <- c(
  "self_ln1", "self_ln2", "self_ln3",
  "self_ln4", "self_ln5", "self_ln6"
)

items_ocio <- c(
  "ocio_1", "ocio_2", "ocio_3",
  "ocio_4", "ocio_5", "ocio_6",
  "ocio_7"
)

items_access <- c(
  "access_1", "access_2", "access_3",
  "access_4", "access_5", "access_6"
)

items_mimic <- c("SENWT", "sex", "ESCS", "ICTENQ", "ICTHOME", "ICTWKEND", "SDLEFF", "gen1", "gen2", "gen3",
  "gen4", "gen5", "gen6",
  "spec1", "spec2", "spec3")

proc_data <- proc_data |>
  filter(if_any(all_of(items_dse), ~ !is.na(.))) |>
  filter(if_any(all_of(items_ictsch), ~ !is.na(.))) |>
  filter(if_any(all_of(items_self_ln), ~ !is.na(.))) |>
  filter(if_any(all_of(items_ocio), ~ !is.na(.))) |>
  filter(if_any(all_of(items_access), ~ !is.na(.))) |>
  group_by(CNT) |>
  slice_sample(n = 100) |>
  ungroup()
```

# Datos para cada subescala

```{r}
dse_data <- proc_data |> select(SENWT, items_dse)
ictsch_data <- proc_data |> select(SENWT, items_ictsch)
self_ln_data <- proc_data |> select(SENWT, items_self_ln)
ocio_data <- proc_data |> select(SENWT, items_ocio)
access_data <- proc_data |> select(SENWT, items_access)
```

# Creación de tabla de descriptivos

```{r}
nombres_descriptivos <- c(
  "gen1" = "Buscar información",
  "gen2" = "Evaluar información",
  "gen3" = "Compartir información",
  "gen4" = "Colaborar en grupo",
  "gen5" = "Explicar cómo compartir",
  "gen6" = "Escribir/editar texto",
  "spec1" = "Crear programa",
  "spec2" = "Pasos lógicos",
  "spec3" = "Identificar error"
)

descriptivos <- psych::describe(proc_data[items_dse])
desc <- psych::response.frequencies(proc_data[items_dse])
desc <- as.data.frame(desc)
desc$skew <- descriptivos$skew
desc$kurtosis <- descriptivos$kurtosis


descriptivos_df <- desc |>
  rownames_to_column(var = "variable") |>
  select(
    variable,
    `1`, `2`, `3`, `4`,
    Asimetría = skew,
    Curtosis = kurtosis,
    `% Casos perdidos` = miss
  ) |>
  mutate(`% Casos perdidos` = `% Casos perdidos` * 100) |>
  mutate(`1` = `1` * 100) |>
  mutate(`2` = `2` * 100) |>
  mutate(`3` = `3` * 100) |>
  mutate(`4` = `4` * 100) |>
  mutate(variable = factor(variable, levels = items_dse)) |>
  arrange(variable) |>
  mutate(variable = recode(variable, !!!nombres_descriptivos)) |>
  rename(Ítem = variable)

```

# Preparación de datos para Mplus (CFA)

```{r}
prepareMplusData(dse_data, filename="mplus_files/dse.dat", inpfile = FALSE)
prepareMplusData(ictsch_data, filename="mplus_files/ictsch.dat", inpfile = FALSE)
prepareMplusData(self_ln_data, filename="mplus_files/selfln.dat", inpfile = FALSE)
prepareMplusData(ocio_data, filename="mplus_files/ocio.dat", inpfile = FALSE)
prepareMplusData(access_data, filename="mplus_files/access.dat", inpfile = FALSE)
```

# Correr los modelos CFA

```{r}
runModels("./mplus_files/")
```

# Extraer indicadores de ajuste y cargas factoriales

```{r}
resultados <- readModels("./mplus_files/")
dse_model <- resultados$dse.out
ictsch_model <- resultados$ictsch.out
self_ln_model <- resultados$selfln.out
ocio_model <- resultados$ocio.out
access_model <- resultados$access.out
```

## DSE
```{r}

dse_fit <- dse_model$summaries |> 
  select(ChiSqM_Value, ChiSqM_PValue, ChiSqM_DF, CFI, TLI, RMSEA_Estimate, RMSEA_90CI_LB, RMSEA_90CI_UB)

dse_loadings <- dse_model$parameters$stdyx.standardized

```


Chi² = 482.7; p < .001; Chi²/df = 25; RMSEA = .061 [.056, .066] ; CFI = .994; TLI = .992

Loadings .84-.93
Cor = .45
Gen1 with Gen2 = .54

## Uso de ICT para el aprendizaje

```{r}

ictsch_fit <- ictsch_model$summaries |> 
  select(ChiSqM_Value, ChiSqM_PValue, ChiSqM_DF, CFI, TLI, RMSEA_Estimate, RMSEA_90CI_LB, RMSEA_90CI_UB)

ictsch_loadings <- ictsch_model$parameters$stdyx.standardized

ictshc_modindices <- ictsch_model$mod_indices
```


El modelo de "Uso de TIC para el apendizaje" presenta un gran desajuste inicial debido a errores correlacionados entre recolectar y almacenar datos y analizar datos (ambas variables referenciando plataformas de hojas de cálculo como Excel) y entre planear y manejar proyectos y llevar el progreso de tus proyectos con plataformas digitales. Al liberar ambos errores, se obtuvo un modelo con un ajuste pobre (Chi² = 1965.576; p < 0.001; Chi²/df = 33; CFI = .97; TLI = .96; RMSEA = .109; IC90% RMSEA [.105, .113]). Las cargas factoriales son altas, de .67 a .85, y la fiabilidad buena ().

## Aprendizaje Autónomo

```{r}

self_ln_fit <- self_ln_model$summaries |> 
  select(ChiSqM_Value, ChiSqM_PValue, ChiSqM_DF, CFI, TLI, RMSEA_Estimate, RMSEA_90CI_LB, RMSEA_90CI_UB)

self_ln_loadings <- self_ln_model$parameters$stdyx.standardized

self_ln_modindices <- self_ln_model$mod_indices

```

El modelo de "Aprendizaje autónomo" presenta un fuerte desajuste inicial debido a errores correlacionados entre   . Al liberar las covarianza entre los errores se consigue un ajuste pobre (Chi² = 471.848; p < 0.001; Chi²/df = 7; CFI = .99; TLI = .978; RMSEA = .116; IC90% RMSEA [.108, .125]). Las cargas factoriales presentan una magnitud alta, entre .73 y .82, y la fiabilidad es buena ().

## Uso de TIC para Ocio

```{r}

ocio_fit <- ocio_model$summaries |> 
  select(ChiSqM_Value, ChiSqM_PValue, ChiSqM_DF, CFI, TLI, RMSEA_Estimate, RMSEA_90CI_LB, RMSEA_90CI_UB)

ocio_loadings <- ocio_model$parameters$stdyx.standardized

ocio_modindices <- ocio_model$mod_indices

```

El modelo de "Uso de TIC para Ocio" presenta un desajuste inicial extremo, con un RMSEA muy por encima del umbral aceptable, de .219, un TLI de .843 y un CFI de .895, debido a una gran cantidad de ítems con errores correlacionados con la utilización de redes sociales. Al eliminar este ítem el modelo mejora, sin embargo sigue considerablemente fuera de los umbrales aceptables, siendo rechazado con un RMSEA de 0.16 y un TLI de 0.929.

## Acceso a TIC en el hogar

```{r}

access_fit <- access_model$summaries |> 
  select(ChiSqM_Value, ChiSqM_PValue, ChiSqM_DF, CFI, TLI, RMSEA_Estimate, RMSEA_90CI_LB, RMSEA_90CI_UB)

access_loadings <- access_model$parameters$stdyx.standardized

access_modindices <- access_model$mod_indices

```

El modelo de accesso también obtiene un desajiste extremo (RMSEA = 0.212; CFI = 0.863; TLI = .772).

# Modelo MIMIC SEM

```{r}

mimic_data <- proc_data |> 
  select(items_mimic)

mimic_data$sex <- as.integer(mimic_data$sex)

mimic_data <- mimic_data |> 
  mutate(sex = if_else(sex==1, 0, 1))

mimic_data$sex <- as.integer(mimic_data$sex)


prepareMplusData(mimic_data, filename="mplus_files/sdsa.dat", inpfile = FALSE)

```

```{r}
runModels("./mplus_files/mimic.inp")
```

chi = 2126.54; chi/df = 74; p < 0.001; RMSEA = .78; IC 90% RMSEA [0.076, 0.081]; CFI = .973; TLI = .963

El efecto del sexo sobre la ADE fue significativo y de .226

# Convertir a tablas flextable y exportar como docx

## Funciones para estilizar las tablas

```{r}
style_desc_table <- function(ft) {
  
  ft <- ft |>
    # GRUPO 1: Las columnas de porcentaje (Respuestas + Missings)
    # Usamos digits = 1 (ej: 25.4%) y agregamos el sufijo
    colformat_double(
      j = c("1", "2", "3", "4", "% Casos perdidos"), 
      digits = 1, 
      suffix = "%"
    ) |>
    
    # GRUPO 2: Los coeficientes estadísticos (Asimetría y Curtosis)
    # Usamos digits = 2 y SIN sufijo
    colformat_double(
      j = c("Asimetría", "Curtosis"), 
      digits = 2
    ) |>
    
    # --- El resto del estilo se mantiene igual ---
    border_remove() |>
    hline_top(border = fp_border(width = 2), part = "header") |> 
    hline_bottom(border = fp_border(width = 2), part = "body") |>
    hline(i = 1, border = fp_border(width = 1.5), part = "header") |>
    
    bold(part = "header") |>
    font(fontname = "Calibri", part = "all") |>
    fontsize(size = 10, part = "body") |>
    fontsize(size = 11, part = "header") |>
    
    padding(padding = 3, part = "all") |>
    align(align = "center", part = "header") |>
    align(align = "left", part = "body", j = 1) |> 
    align(align = "center", part = "body", j = 2:ncol(ft$body$dataset)) |> 
    autofit() 

  return(ft)
}
```



## Exportación de tablas en formato docx


```{r}

ft_descriptivos <- flextable(descriptivos_df) |>
  style_desc_table() |> 
  add_header_row(values = "Tabla 2: Estadísticos Descriptivos de los Ítems", colwidths = ncol(descriptivos_df))

save_as_docx(
  ft_descriptivos, 
  path = "figures/tabla_descriptivos.docx"
)

```